# 云盘服务器端项目说明

## 项目概述

本项目是一个云盘服务器端实现，支持用户注册、登录、文件列表查看、文件上传、下载、删除、分享等功能。服务器采用C语言开发，基于TCP协议进行网络通信，使用MySQL数据库存储用户信息和操作记录，通过epoll实现IO多路复用，结合线程池处理并发请求，提供高效稳定的云存储服务。

## 功能说明

1. **用户管理**：支持用户注册和登录功能，验证用户身份并创建用户专属目录
2. **文件操作**：
   - 查看文件列表
   - 上传文件
   - 下载文件
   - 删除文件
3. **文件分享**：支持用户间文件分享功能
4. **操作记录**：记录用户的操作历史

## 技术架构

### 整体架构

服务器采用**IO多路复用+线程池**的架构模式：
- 使用epoll实现IO多路复用，高效处理多个客户端连接
- 线程池处理具体业务逻辑，实现并发处理
- 采用分层设计，分离网络通信、业务逻辑和数据存储

### 核心技术点

1. **网络编程**：TCP socket通信、epoll IO多路复用
2. **多线程**：线程池、互斥锁、信号量同步
3. **数据存储**：MySQL数据库操作
4. **数据格式**：JSON格式进行数据交换
5. **文件系统**：目录创建、文件操作、路径安全检查
6. **日志系统**：记录服务器运行状态和用户操作
7. **进程管理**：守护进程模式运行

## 代码结构

```
realpro/
├── business.c       # 业务逻辑处理函数
├── business.h       # 业务逻辑函数声明
├── cloud_disk.h     # 全局常量、结构体和函数声明
├── main.c           # 服务器主函数，包含epoll事件循环
├── utils.c          # 工具函数（日志、路径处理等）
├── utils.h          # 工具函数声明
└── Makefile         # 编译配置文件
```

## 核心模块说明

### 1. 主程序模块（main.c）

- **main函数**：服务器入口点，负责初始化服务器、创建监听socket、设置epoll事件循环
- **信号处理**：处理SIGINT、SIGTERM等信号，实现优雅退出
- **epoll事件循环**：监听并处理新连接和客户端请求，分发任务到线程池

### 2. 业务逻辑模块（business.c）

- **用户认证**：
  - `handle_login`：处理用户登录请求，验证用户名密码，创建用户目录
  - `handle_register`：处理用户注册请求，添加新用户到数据库

- **文件操作**：
  - `handle_file_list`：处理文件列表请求，返回指定路径下的文件信息
  - `handle_upload_ctl`/`handle_upload`：处理文件上传请求和数据
  - `handle_download_ctl`/`handle_download`：处理文件下载请求和数据
  - `handle_delete`：处理文件/目录删除请求

- **其他功能**：
  - `handle_share`：处理文件分享请求
  - `handle_history_query`：处理操作历史查询请求

### 3. 工具模块（utils.c）

- **日志功能**：`write_log`记录服务器运行日志
- **路径处理**：`is_safe_path`检查路径安全性（防止路径穿越）、`build_full_path`构建文件完整路径
- **目录操作**：`mkdir_recursive`递归创建目录
- **JSON处理**：`send_json_response`发送JSON格式响应

## 编译与运行

### 编译

make

### 运行（前台模式）

./cloud_disk_server -f

### 安装到系统

sudo make install
